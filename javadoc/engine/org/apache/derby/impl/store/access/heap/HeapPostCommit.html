<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc (1.8.0_66) on Mon Jul 03 23:05:22 IST 2017 -->
<title>HeapPostCommit (Apache Derby V10.13 Internals)</title>
<meta name="date" content="2017-07-03">
<link rel="stylesheet" type="text/css" href="../../../../../../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../../../../../../script.js"></script>
</head>
<body>
<script type="text/javascript"><!--
    try {
        if (location.href.indexOf('is-external=true') == -1) {
            parent.document.title="HeapPostCommit (Apache Derby V10.13 Internals)";
        }
    }
    catch(err) {
    }
//-->
var methods = {"i0":10,"i1":10,"i2":10,"i3":10};
var tabs = {65535:["t0","All Methods"],2:["t2","Instance Methods"],8:["t4","Concrete Methods"]};
var altColor = "altColor";
var rowColor = "rowColor";
var tableTab = "tableTab";
var activeTableTab = "activeTableTab";
</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="topNav"><a name="navbar.top">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.top" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.top.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../../../../overview-summary.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="navBarCell1Rev">Class</li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../../../../index-all.html">Index</a></li>
<li><a href="../../../../../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../../../../org/apache/derby/impl/store/access/heap/HeapCostController.html" title="class in org.apache.derby.impl.store.access.heap"><span class="typeNameLink">Prev&nbsp;Class</span></a></li>
<li><a href="../../../../../../../org/apache/derby/impl/store/access/heap/HeapRowLocation.html" title="class in org.apache.derby.impl.store.access.heap"><span class="typeNameLink">Next&nbsp;Class</span></a></li>
</ul>
<ul class="navList">
<li><a href="../../../../../../../index.html?org/apache/derby/impl/store/access/heap/HeapPostCommit.html" target="_top">Frames</a></li>
<li><a href="HeapPostCommit.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_top">
<li><a href="../../../../../../../allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_top");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<div>
<ul class="subNavList">
<li>Summary:&nbsp;</li>
<li>Nested&nbsp;|&nbsp;</li>
<li><a href="#field.summary">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#constructor.summary">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method.summary">Method</a></li>
</ul>
<ul class="subNavList">
<li>Detail:&nbsp;</li>
<li><a href="#field.detail">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#constructor.detail">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method.detail">Method</a></li>
</ul>
</div>
<a name="skip.navbar.top">
<!--   -->
</a></div>
<!-- ========= END OF TOP NAVBAR ========= -->
<!-- ======== START OF CLASS DATA ======== -->
<div class="header">
<div class="subTitle">org.apache.derby.impl.store.access.heap</div>
<h2 title="Class HeapPostCommit" class="title">Class HeapPostCommit</h2>
</div>
<div class="contentContainer">
<ul class="inheritance">
<li>java.lang.Object</li>
<li>
<ul class="inheritance">
<li>org.apache.derby.impl.store.access.heap.HeapPostCommit</li>
</ul>
</li>
</ul>
<div class="description">
<ul class="blockList">
<li class="blockList">
<dl>
<dt>All Implemented Interfaces:</dt>
<dd><a href="../../../../../../../org/apache/derby/iapi/services/daemon/Serviceable.html" title="interface in org.apache.derby.iapi.services.daemon">Serviceable</a></dd>
</dl>
<hr>
<br>
<pre>class <span class="typeNameLabel">HeapPostCommit</span>
extends java.lang.Object
implements <a href="../../../../../../../org/apache/derby/iapi/services/daemon/Serviceable.html" title="interface in org.apache.derby.iapi.services.daemon">Serviceable</a></pre>
<div class="block">The HeapPostCommit class implements the Serviceable protocol.  

In it's role as a Serviceable object, it stores the state necessary to 
find a page in a heap that may have committed delete's to reclaim.

It looks up the page described, and reclaims space in the conglomerate.  
It first trys to clean up any deleted commits on the page.  It will then 
deallocate the page if no rows remain on the page.  All work is done while
holding the latch on the page, and locks are never "waited" on while holding
this latch.

This implementation uses record level locking to reclaim the space.  
For the protocols to work correctly all other heap methods must be 
prepared for a record or a page to "disappear" if they don't hold a latch and/or
a lock.  An example of the problem case is a scan which does not hold locks
on it's current position (group scan works this way), which is positioned
on a row deleted by another xact, it must be prepared to continue the 
scan after getting an error if the current page/row disapppears.</div>
</li>
</ul>
</div>
<div class="summary">
<ul class="blockList">
<li class="blockList">
<!-- =========== FIELD SUMMARY =========== -->
<ul class="blockList">
<li class="blockList"><a name="field.summary">
<!--   -->
</a>
<h3>Field Summary</h3>
<table class="memberSummary" border="0" cellpadding="3" cellspacing="0" summary="Field Summary table, listing fields, and an explanation">
<caption><span>Fields</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Modifier and Type</th>
<th class="colLast" scope="col">Field and Description</th>
</tr>
<tr class="altColor">
<td class="colFirst"><code>private <a href="../../../../../../../org/apache/derby/iapi/store/access/AccessFactory.html" title="interface in org.apache.derby.iapi.store.access">AccessFactory</a></code></td>
<td class="colLast"><code><span class="memberNameLink"><a href="../../../../../../../org/apache/derby/impl/store/access/heap/HeapPostCommit.html#access_factory">access_factory</a></span></code>
<div class="block">Fields of the class</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><code>private <a href="../../../../../../../org/apache/derby/iapi/store/raw/PageKey.html" title="class in org.apache.derby.iapi.store.raw">PageKey</a></code></td>
<td class="colLast"><code><span class="memberNameLink"><a href="../../../../../../../org/apache/derby/impl/store/access/heap/HeapPostCommit.html#page_key">page_key</a></span></code>&nbsp;</td>
</tr>
</table>
<ul class="blockList">
<li class="blockList"><a name="fields.inherited.from.class.org.apache.derby.iapi.services.daemon.Serviceable">
<!--   -->
</a>
<h3>Fields inherited from interface&nbsp;org.apache.derby.iapi.services.daemon.<a href="../../../../../../../org/apache/derby/iapi/services/daemon/Serviceable.html" title="interface in org.apache.derby.iapi.services.daemon">Serviceable</a></h3>
<code><a href="../../../../../../../org/apache/derby/iapi/services/daemon/Serviceable.html#DONE">DONE</a>, <a href="../../../../../../../org/apache/derby/iapi/services/daemon/Serviceable.html#REQUEUE">REQUEUE</a></code></li>
</ul>
</li>
</ul>
<!-- ======== CONSTRUCTOR SUMMARY ======== -->
<ul class="blockList">
<li class="blockList"><a name="constructor.summary">
<!--   -->
</a>
<h3>Constructor Summary</h3>
<table class="memberSummary" border="0" cellpadding="3" cellspacing="0" summary="Constructor Summary table, listing constructors, and an explanation">
<caption><span>Constructors</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colOne" scope="col">Constructor and Description</th>
</tr>
<tr class="altColor">
<td class="colOne"><code><span class="memberNameLink"><a href="../../../../../../../org/apache/derby/impl/store/access/heap/HeapPostCommit.html#HeapPostCommit-org.apache.derby.iapi.store.access.AccessFactory-org.apache.derby.iapi.store.raw.PageKey-">HeapPostCommit</a></span>(<a href="../../../../../../../org/apache/derby/iapi/store/access/AccessFactory.html" title="interface in org.apache.derby.iapi.store.access">AccessFactory</a>&nbsp;access_factory,
              <a href="../../../../../../../org/apache/derby/iapi/store/raw/PageKey.html" title="class in org.apache.derby.iapi.store.raw">PageKey</a>&nbsp;page_key)</code>
<div class="block">Constructors for This class:</div>
</td>
</tr>
</table>
</li>
</ul>
<!-- ========== METHOD SUMMARY =========== -->
<ul class="blockList">
<li class="blockList"><a name="method.summary">
<!--   -->
</a>
<h3>Method Summary</h3>
<table class="memberSummary" border="0" cellpadding="3" cellspacing="0" summary="Method Summary table, listing methods, and an explanation">
<caption><span id="t0" class="activeTableTab"><span>All Methods</span><span class="tabEnd">&nbsp;</span></span><span id="t2" class="tableTab"><span><a href="javascript:show(2);">Instance Methods</a></span><span class="tabEnd">&nbsp;</span></span><span id="t4" class="tableTab"><span><a href="javascript:show(8);">Concrete Methods</a></span><span class="tabEnd">&nbsp;</span></span></caption>
<tr>
<th class="colFirst" scope="col">Modifier and Type</th>
<th class="colLast" scope="col">Method and Description</th>
</tr>
<tr id="i0" class="altColor">
<td class="colFirst"><code>int</code></td>
<td class="colLast"><code><span class="memberNameLink"><a href="../../../../../../../org/apache/derby/impl/store/access/heap/HeapPostCommit.html#performWork-org.apache.derby.iapi.services.context.ContextManager-">performWork</a></span>(<a href="../../../../../../../org/apache/derby/iapi/services/context/ContextManager.html" title="class in org.apache.derby.iapi.services.context">ContextManager</a>&nbsp;contextMgr)</code>
<div class="block">perform the work described in the postcommit work.</div>
</td>
</tr>
<tr id="i1" class="rowColor">
<td class="colFirst"><code>private void</code></td>
<td class="colLast"><code><span class="memberNameLink"><a href="../../../../../../../org/apache/derby/impl/store/access/heap/HeapPostCommit.html#purgeCommittedDeletes-org.apache.derby.impl.store.access.heap.HeapController-long-">purgeCommittedDeletes</a></span>(<a href="../../../../../../../org/apache/derby/impl/store/access/heap/HeapController.html" title="class in org.apache.derby.impl.store.access.heap">HeapController</a>&nbsp;heap_control,
                     long&nbsp;pageno)</code>
<div class="block">Reclaim space taken of committed deleted rows or aborted inserted rows.</div>
</td>
</tr>
<tr id="i2" class="altColor">
<td class="colFirst"><code>boolean</code></td>
<td class="colLast"><code><span class="memberNameLink"><a href="../../../../../../../org/apache/derby/impl/store/access/heap/HeapPostCommit.html#serviceASAP--">serviceASAP</a></span>()</code>
<div class="block">The urgency of this post commit work.</div>
</td>
</tr>
<tr id="i3" class="rowColor">
<td class="colFirst"><code>boolean</code></td>
<td class="colLast"><code><span class="memberNameLink"><a href="../../../../../../../org/apache/derby/impl/store/access/heap/HeapPostCommit.html#serviceImmediately--">serviceImmediately</a></span>()</code>
<div class="block">If this work should be done immediately on the user thread then return true.</div>
</td>
</tr>
</table>
<ul class="blockList">
<li class="blockList"><a name="methods.inherited.from.class.java.lang.Object">
<!--   -->
</a>
<h3>Methods inherited from class&nbsp;java.lang.Object</h3>
<code>clone, equals, finalize, getClass, hashCode, notify, notifyAll, toString, wait, wait, wait</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="details">
<ul class="blockList">
<li class="blockList">
<!-- ============ FIELD DETAIL =========== -->
<ul class="blockList">
<li class="blockList"><a name="field.detail">
<!--   -->
</a>
<h3>Field Detail</h3>
<a name="access_factory">
<!--   -->
</a>
<ul class="blockList">
<li class="blockList">
<h4>access_factory</h4>
<pre>private&nbsp;<a href="../../../../../../../org/apache/derby/iapi/store/access/AccessFactory.html" title="interface in org.apache.derby.iapi.store.access">AccessFactory</a> access_factory</pre>
<div class="block">Fields of the class</div>
</li>
</ul>
<a name="page_key">
<!--   -->
</a>
<ul class="blockListLast">
<li class="blockList">
<h4>page_key</h4>
<pre>private&nbsp;<a href="../../../../../../../org/apache/derby/iapi/store/raw/PageKey.html" title="class in org.apache.derby.iapi.store.raw">PageKey</a> page_key</pre>
</li>
</ul>
</li>
</ul>
<!-- ========= CONSTRUCTOR DETAIL ======== -->
<ul class="blockList">
<li class="blockList"><a name="constructor.detail">
<!--   -->
</a>
<h3>Constructor Detail</h3>
<a name="HeapPostCommit-org.apache.derby.iapi.store.access.AccessFactory-org.apache.derby.iapi.store.raw.PageKey-">
<!--   -->
</a>
<ul class="blockListLast">
<li class="blockList">
<h4>HeapPostCommit</h4>
<pre>HeapPostCommit(<a href="../../../../../../../org/apache/derby/iapi/store/access/AccessFactory.html" title="interface in org.apache.derby.iapi.store.access">AccessFactory</a>&nbsp;access_factory,
               <a href="../../../../../../../org/apache/derby/iapi/store/raw/PageKey.html" title="class in org.apache.derby.iapi.store.raw">PageKey</a>&nbsp;page_key)</pre>
<div class="block">Constructors for This class:</div>
</li>
</ul>
</li>
</ul>
<!-- ============ METHOD DETAIL ========== -->
<ul class="blockList">
<li class="blockList"><a name="method.detail">
<!--   -->
</a>
<h3>Method Detail</h3>
<a name="purgeCommittedDeletes-org.apache.derby.impl.store.access.heap.HeapController-long-">
<!--   -->
</a>
<ul class="blockList">
<li class="blockList">
<h4>purgeCommittedDeletes</h4>
<pre>private final&nbsp;void&nbsp;purgeCommittedDeletes(<a href="../../../../../../../org/apache/derby/impl/store/access/heap/HeapController.html" title="class in org.apache.derby.impl.store.access.heap">HeapController</a>&nbsp;heap_control,
                                         long&nbsp;pageno)
                                  throws <a href="../../../../../../../org/apache/derby/iapi/error/StandardException.html" title="class in org.apache.derby.iapi.error">StandardException</a></pre>
<div class="block">Reclaim space taken of committed deleted rows or aborted inserted rows.
 <p>
 This routine assumes it has been called by an internal transaction which
 has performed no work so far, and that it has an exclusive intent table 
 lock.  It will attempt obtain exclusive row locks on rows marked 
 deleted, where successful those rows can be reclaimed as they must be 
 "committed deleted" or "aborted inserted" rows.
 <p>
 This routine will latch the page and hold the latch due to interface
 requirement from Page.purgeAtSlot.</div>
<dl>
<dt><span class="paramLabel">Parameters:</span></dt>
<dd><code>heap_control</code> - The heap, already opened.</dd>
<dd><code>pageno</code> - number of page to look for committed deletes.</dd>
<dt><span class="throwsLabel">Throws:</span></dt>
<dd><code><a href="../../../../../../../org/apache/derby/iapi/error/StandardException.html" title="class in org.apache.derby.iapi.error">StandardException</a></code> - Standard exception policy.</dd>
<dt><span class="seeLabel">See Also:</span></dt>
<dd><a href="../../../../../../../org/apache/derby/iapi/store/raw/Page.html#purgeAtSlot-int-int-boolean-"><code>Page.purgeAtSlot(int, int, boolean)</code></a></dd>
</dl>
</li>
</ul>
<a name="serviceASAP--">
<!--   -->
</a>
<ul class="blockList">
<li class="blockList">
<h4>serviceASAP</h4>
<pre>public&nbsp;boolean&nbsp;serviceASAP()</pre>
<div class="block">The urgency of this post commit work.
 <p>
 This determines where this Serviceable is put in the post commit 
 queue.  Post commit work in the heap can be safely delayed until there
 is not user work to do.</div>
<dl>
<dt><span class="overrideSpecifyLabel">Specified by:</span></dt>
<dd><code><a href="../../../../../../../org/apache/derby/iapi/services/daemon/Serviceable.html#serviceASAP--">serviceASAP</a></code>&nbsp;in interface&nbsp;<code><a href="../../../../../../../org/apache/derby/iapi/services/daemon/Serviceable.html" title="interface in org.apache.derby.iapi.services.daemon">Serviceable</a></code></dd>
<dt><span class="returnLabel">Returns:</span></dt>
<dd>false, this work should not be serviced ASAP</dd>
</dl>
</li>
</ul>
<a name="serviceImmediately--">
<!--   -->
</a>
<ul class="blockList">
<li class="blockList">
<h4>serviceImmediately</h4>
<pre>public&nbsp;boolean&nbsp;serviceImmediately()</pre>
<div class="block"><span class="descfrmTypeLabel">Description copied from interface:&nbsp;<code><a href="../../../../../../../org/apache/derby/iapi/services/daemon/Serviceable.html#serviceImmediately--">Serviceable</a></code></span></div>
<div class="block">If this work should be done immediately on the user thread then return true.  
                If it doesn't make any difference if this work is done on a the user thread
                immediately or if it is performed by another thread asynchronously
                later, then return false.</div>
<dl>
<dt><span class="overrideSpecifyLabel">Specified by:</span></dt>
<dd><code><a href="../../../../../../../org/apache/derby/iapi/services/daemon/Serviceable.html#serviceImmediately--">serviceImmediately</a></code>&nbsp;in interface&nbsp;<code><a href="../../../../../../../org/apache/derby/iapi/services/daemon/Serviceable.html" title="interface in org.apache.derby.iapi.services.daemon">Serviceable</a></code></dd>
</dl>
</li>
</ul>
<a name="performWork-org.apache.derby.iapi.services.context.ContextManager-">
<!--   -->
</a>
<ul class="blockListLast">
<li class="blockList">
<h4>performWork</h4>
<pre>public&nbsp;int&nbsp;performWork(<a href="../../../../../../../org/apache/derby/iapi/services/context/ContextManager.html" title="class in org.apache.derby.iapi.services.context">ContextManager</a>&nbsp;contextMgr)
                throws <a href="../../../../../../../org/apache/derby/iapi/error/StandardException.html" title="class in org.apache.derby.iapi.error">StandardException</a></pre>
<div class="block">perform the work described in the postcommit work.
 <p>
 In this implementation the only work that can be executed by this
 post commit processor is this class itself.
 <p></div>
<dl>
<dt><span class="overrideSpecifyLabel">Specified by:</span></dt>
<dd><code><a href="../../../../../../../org/apache/derby/iapi/services/daemon/Serviceable.html#performWork-org.apache.derby.iapi.services.context.ContextManager-">performWork</a></code>&nbsp;in interface&nbsp;<code><a href="../../../../../../../org/apache/derby/iapi/services/daemon/Serviceable.html" title="interface in org.apache.derby.iapi.services.daemon">Serviceable</a></code></dd>
<dt><span class="paramLabel">Parameters:</span></dt>
<dd><code>contextMgr</code> - the context manager started by the post commit daemon</dd>
<dt><span class="returnLabel">Returns:</span></dt>
<dd>Returns Serviceable.DONE when work has completed, or
         returns Serviceable.REQUEUE if work needs to be requeued.</dd>
<dt><span class="throwsLabel">Throws:</span></dt>
<dd><code><a href="../../../../../../../org/apache/derby/iapi/error/StandardException.html" title="class in org.apache.derby.iapi.error">StandardException</a></code> - Standard exception policy.</dd>
</dl>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<!-- ========= END OF CLASS DATA ========= -->
<!-- ======= START OF BOTTOM NAVBAR ====== -->
<div class="bottomNav"><a name="navbar.bottom">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.bottom" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.bottom.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../../../../overview-summary.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="navBarCell1Rev">Class</li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../../../../index-all.html">Index</a></li>
<li><a href="../../../../../../../help-doc.html">Help</a></li>
</ul>
<div class="aboutLanguage">Built on Mon 2017-07-03 23:03:59+0530, from revision Unversioned directory</div>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../../../../org/apache/derby/impl/store/access/heap/HeapCostController.html" title="class in org.apache.derby.impl.store.access.heap"><span class="typeNameLink">Prev&nbsp;Class</span></a></li>
<li><a href="../../../../../../../org/apache/derby/impl/store/access/heap/HeapRowLocation.html" title="class in org.apache.derby.impl.store.access.heap"><span class="typeNameLink">Next&nbsp;Class</span></a></li>
</ul>
<ul class="navList">
<li><a href="../../../../../../../index.html?org/apache/derby/impl/store/access/heap/HeapPostCommit.html" target="_top">Frames</a></li>
<li><a href="HeapPostCommit.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_bottom">
<li><a href="../../../../../../../allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_bottom");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<div>
<ul class="subNavList">
<li>Summary:&nbsp;</li>
<li>Nested&nbsp;|&nbsp;</li>
<li><a href="#field.summary">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#constructor.summary">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method.summary">Method</a></li>
</ul>
<ul class="subNavList">
<li>Detail:&nbsp;</li>
<li><a href="#field.detail">Field</a>&nbsp;|&nbsp;</li>
<li><a href="#constructor.detail">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method.detail">Method</a></li>
</ul>
</div>
<a name="skip.navbar.bottom">
<!--   -->
</a></div>
<!-- ======== END OF BOTTOM NAVBAR ======= -->
<p class="legalCopy"><small>Apache Derby V10.13 Internals - <i>Copyright &copy; 2004,2016 The Apache Software Foundation. All Rights Reserved.</i></small></p>
</body>
</html>
